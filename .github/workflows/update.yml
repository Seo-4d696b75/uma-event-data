name: auto-update
on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 15 * * *' # JST(UTC+0900) で毎時0:00に実行
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v1
        with:
          ref: 'main'
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.6'
      - name: update
        run: ruby src/update.rb
      - name: check diff
        id: diff
        run: |
          git add -N . # 新規ファイルを含める
          echo "::set-output name=count::$(git diff --name-only | wc -l)"
      - name: run test # 以降は差分がある場合のみ実行
        if: steps.diff.outputs.count > 0 
        run: |
          echo "::add-matcher::.github/problem-matcher.json"
          gem install minitest
          ruby src/test.rb
      - name: commit update # 更新差分を一旦コミット
        if: steps.diff.outputs.count > 0
        run: |
          git config --global user.email "s.kaoru509@gmail.com"
          git config --global user.name "Seo-4d696b75"
          git add .
          git commit -m "[update] event data"
      - name: release # 公開するデータフォーマットに変換
        if: steps.diff.outputs.count > 0
        run: ruby src/release.rb
      - name: commit and push
        if: steps.diff.outputs.count > 0
        env:
          REPO: https://${{github.actor}}:${{secrets.GITHUB_TOKEN}}@github.com/${{github.repository}}.git
        run: |
          git add .
          git commit -m "[release] latest data"
          git push ${REPO} main
